# Deploy WordPress
name: WordPress Deployment

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ main ]

jobs:
  # ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á dev
  test:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    steps:
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Repository
    - uses: actions/checkout@v3
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
    - name: Set up environment
      run: |
        cp .env.example .env
        
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Deploy WordPress ‡∏î‡πâ‡∏ß‡∏¢ Docker Compose ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    - name: Deploy WordPress with Docker Compose for testing
      run: |
        docker-compose down
        docker-compose up -d wordpress-test db phpmyadmin
        
    # Add a step to check container status and get network info
    - name: Check container status
      run: |
        echo "Checking running containers:"
        docker ps
        echo "Network information:"
        docker network ls
        echo "Adding wp-test to hosts file for DNS resolution:"
        CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -q -f name=wordpress-test))
        echo "$CONTAINER_IP wp-test" | sudo tee -a /etc/hosts
        echo "Container IP: $CONTAINER_IP"
        
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö WordPress ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    - name: Basic WordPress Tests
      run: |
        echo "üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö WordPress ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô"
        
        echo "Testing with localhost:80 first:"
        if curl -i localhost:80 > test_localhost.txt; then
          cat test_localhost.txt
          echo "‚úÖ Localhost connection successful"
        else
          echo "‚ùå Localhost connection failed"
        fi
        
        echo "Testing with container IP:"
        CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -q -f name=wordpress-test))
        if curl -i $CONTAINER_IP:80 > test_ip.txt; then
          cat test_ip.txt
          echo "‚úÖ Container IP connection successful"
        else
          echo "‚ùå Container IP connection failed"
        fi
        
        # Attempt with wp-test hostname after adding to hosts
        echo "Testing with wp-test:80:"
        if curl -i wp-test:80 > test.txt; then
          # Display the content for debugging
          echo "Response content:"
          cat test.txt
          
          # Check for WordPress redirect header
          if grep -q "X-Redirect-By: WordPress" test.txt; then
            echo "‚úÖ ‡∏û‡∏ö X-Redirect-By: WordPress header - WordPress ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥"
          else
            echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö X-Redirect-By: WordPress header - WordPress ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤"
          fi
        else
          echo "‚ùå Connection to wp-test failed"
        fi
        
        echo "üèÅ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"

  # ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Deploy ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Pull Request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á main
  deploy:
    runs-on: self-hosted
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Repository
    - uses: actions/checkout@v3
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
    - name: Set up environment
      run: |
        cp .env.example .env
        
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Deploy WordPress ‡∏î‡πâ‡∏ß‡∏¢ Docker Compose ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Production
    - name: Deploy WordPress with Docker Compose
      run: |
        docker-compose down
        docker-compose up -d wordpress-prod db phpmyadmin

